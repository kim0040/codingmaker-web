# π” CMLMS μ§€μ‹μ„ μ”κµ¬μ‚¬ν•­ κ²€μ¦ μ²΄ν¬λ¦¬μ¤νΈ

**κ²€μ¦μΌ**: 2024-11-20  
**λ€μƒ**: μ½”λ”©λ©”μ΄μ»¤ ν•™μ› ν†µν•© κ΄€λ¦¬ μ‹μ¤ν…

---

## β… 1. λ³΄μ• λ° μ•”νΈν™” (Security) - μµμ°μ„  κ³Όμ 

### 1.1 AES-256 μ•”νΈν™” (Random IV)

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ μ„μΉ | λΉ„κ³  |
|---------|------|----------|------|
| Random IV μƒμ„± (16 bytes) | β… | `crypto.service.ts:24` | `crypto.randomBytes(16)` |
| iv:ciphertext ν¬λ§· μ €μ¥ | β… | `crypto.service.ts:28` | μ¬λ°”λ¥Έ ν¬λ§· |
| μ•”νΈν™” λ€μƒ: μ‹¤λ… (name) | β… | `auth.service.ts`, `seed.ts` | μλ™ μ•”νΈν™” |
| μ•”νΈν™” λ€μƒ: μ „ν™”λ²νΈ (phone) | β… | `auth.service.ts`, `seed.ts` | μλ™ μ•”νΈν™” |
| μ•”νΈν™” λ€μƒ: μ£Όμ† (address) | β… | `auth.service.ts`, `seed.ts` | μλ™ μ•”νΈν™” |
| μ•”νΈν™” λ€μƒ: 1:1 DM | β… | `chat.controller.ts:285` | type="dm"μΌ λ• μλ™ |
| CIPHER_KEY ν™κ²½λ³€μ κ΄€λ¦¬ | β… | `.env` | 32-byte hex |
| κ³ μ • IV μ‚¬μ© κΈμ§€ | β… | `crypto.service.ts` | λ§¤λ² Random μƒμ„± |

### 1.2 λΉ„λ°€λ²νΈ ν•΄μ‹±

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ μ„μΉ | λΉ„κ³  |
|---------|------|----------|------|
| bcrypt μ‚¬μ© | β… | `auth.service.ts` | bcrypt.hash/compare |
| Salt μλ™ μƒμ„± | β… | `bcrypt.hash(10)` | μλ™ Salt |

### 1.3 JWT μΈμ¦

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ μ„μΉ | λΉ„κ³  |
|---------|------|----------|------|
| JWT ν† ν° λ°κΈ‰ | β… | `auth.service.ts:27-36` | μ™„λ£ |
| ν† ν° λ§λ£ (7μΌ) | β… | `.env`: JWT_EXPIRES_IN=7d | μ„¤μ • μ™„λ£ |
| μΈμ¦ λ―Έλ“¤μ›¨μ–΄ | β… | `middleware/auth.ts` | λ¨λ“  λ³΄νΈλ λΌμ°νΈ |

---

## β… 2. λ°μ΄ν„°λ² μ΄μ¤ (Database)

### 2.1 Dual DB μ „λµ

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ μ„μΉ | λΉ„κ³  |
|---------|------|----------|------|
| κ°λ° ν™κ²½: SQLite | β… | `schema.prisma:6` | ν„μ¬ μ„¤μ •λ¨ |
| μ΄μ ν™κ²½: MySQL μ§€μ› | β οΈ | **μμ • ν•„μ”** | ν™κ²½λ³€μ κΈ°λ° μ „ν™ ν•„μ” |
| DATABASE_PROVIDER ν™κ²½λ³€μ | β οΈ | **μ¶”κ°€ ν•„μ”** | ν„μ¬ μ—†μ |

### 2.2 Prisma μ¤ν‚¤λ§ λ¨λΈ

| λ¨λΈ | μƒνƒ | μ”κµ¬μ‚¬ν•­ λ§μ΅± | λΉ„κ³  |
|------|------|--------------|------|
| User | β… | β… | λ¨λ“  ν•„λ“ ν¬ν•¨ |
| Attendance | β… | β… | μ¶μ„ κΈ°λ΅ |
| Post | β… | β… | κ²μ‹κΈ€ |
| Comment | β… | β… | λ“κΈ€ |
| ChatRoom | β… | β… | μ±„ν…λ°© |
| Message | β… | β… | λ©”μ‹μ§€ (μ•”νΈν™” ν”λκ·Έ) |
| Course | β… | β… | λ™μ  μ»¤λ¦¬νλΌ |
| AcademyInfo | β… | β… | ν•™μ› μ •λ³΄ CMS |
| AuditLog | β… | β… | κ°μ‚¬ λ΅κ·Έ |
| Friendship | β… | β… | μΉκµ¬ μ‹μ¤ν… |

### 2.3 μ΄κΈ° λ°μ΄ν„° (Seed)

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ μ„μΉ | λΉ„κ³  |
|---------|------|----------|------|
| κ΄€λ¦¬μ κ³„μ • μƒμ„± | β… | `seed.ts:10-22` | admin/admin1234 |
| ν•™μ› μ •λ³΄ Insert | β… | `seed.ts:24-46` | 6κ° ν•­λ© |
| κΈ°λ³Έ μ»¤λ¦¬νλΌ 3κ° | β… | `seed.ts:48-81` | μ½”λ”©/λ©”μ΄μ»¤/μκ²©μ¦ |

---

## β… 3. API μ—”λ“ν¬μΈνΈ (REST API)

### 3.1 ν•„μ API

| μΉ΄ν…κ³ λ¦¬ | μ—”λ“ν¬μΈνΈ μ | μƒνƒ | λΉ„κ³  |
|---------|-------------|------|------|
| μΈμ¦ (Auth) | 3 | β… | login, register, me |
| μ¶μ„ (Attendance) | 2 | β… | checkin, user/:userId |
| ν•™μ› μ •λ³΄ (Academy) | 2 | β… | info GET/PUT |
| μ»¤λ¦¬νλΌ (Courses) | 4 | β… | CRUD μ™„μ„± |
| μ»¤λ®¤λ‹ν‹° (Community) | 5 | β… | posts, comments, likes |
| μΉκµ¬ (Friends) | 4 | β… | request, accept, list, delete |
| μ‚¬μ©μ (Users) | 1 | β… | profile |
| μ±„ν… (Chat) | 4 | β… | rooms, messages |
| **μ΄κ³„** | **25κ°** | β… | **λ¨λ‘ κµ¬ν„** |

### 3.2 κ¶ν• μ²΄κ³„ (Tier System)

| Tier | μ—­ν•  | κµ¬ν„ μƒνƒ | λΉ„κ³  |
|------|------|----------|------|
| Tier 1 | μµκ³  κ΄€λ¦¬μ (μ›μ¥) | β… | λ¨λ“  κΈ°λ¥ |
| Tier 2 | κ΄€λ¦¬μ (κ°•μ‚¬) | β… | μ»¤λ¦¬νλΌ κ΄€λ¦¬ |
| Tier 3 | μ •νμ›/ν•™λ¶€λ¨/λ…μ | β… | μ»¤λ®¤λ‹ν‹°, μ±„ν… |
| Tier 4 | λΉ„μ •κ·νμ› | β… | μ ν•μ  μ ‘κ·Ό |
| Tier 5 | κ²μ¤νΈ | β… | μ½κΈ° μ „μ© |

---

## β… 4. μ‹¤μ‹κ°„ ν†µμ‹  (Socket.io)

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ μ„μΉ | λΉ„κ³  |
|---------|------|----------|------|
| Socket.io μ„λ²„ | β… | `socket/index.ts` | μ™„λ£ |
| JWT μΈμ¦ λ―Έλ“¤μ›¨μ–΄ | β… | `socket/index.ts:13-39` | ν† ν° κ²€μ¦ |
| μ±„ν… λ©”μ‹μ§€ μ‹¤μ‹κ°„ | β… | `chat:send-message` | μ™„λ£ |
| νƒ€μ΄ν•‘ ν‘μ‹ | β… | `chat:typing` | μ™„λ£ |
| μ¶μ„ μ•λ¦Ό | β… | `attendance:notify` | μ™„λ£ |

---

## β… 5. ν•µμ‹¬ κΈ°λ¥

### 5.1 μ¶μ„ μ‹μ¤ν…

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ | λΉ„κ³  |
|---------|------|------|------|
| νƒκ·Έ κΈ°λ° μ¶μ„ | β… | `POST /attendance/checkin` | tag μ…λ ¥ |
| ν•™λ¶€λ¨ μ•λ¦Ό | β… | Socket.io | μ‹¤μ‹κ°„ μ „μ†΅ |
| μ¶μ„ λ‚΄μ—­ μ΅°ν | β… | `GET /attendance/user/:userId` | ν†µκ³„ ν¬ν•¨ |

### 5.2 λ™μ  μ»¤λ¦¬νλΌ (CMS)

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ | λΉ„κ³  |
|---------|------|------|------|
| μ»¤λ¦¬νλΌ μƒμ„±/μμ •/μ‚­μ  | β… | `courses/*` API | Tier 1,2 |
| ν•λ“μ½”λ”© κΈμ§€ | β… | DB κΈ°λ° κ΄€λ¦¬ | Course λ¨λΈ |
| μΉ΄ν…κ³ λ¦¬ λ™μ  κ΄€λ¦¬ | β… | category ν•„λ“ | μμ  μ…λ ¥ |

### 5.3 ν•™μ› μ •λ³΄ κ΄€λ¦¬ (CMS)

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ | λΉ„κ³  |
|---------|------|------|------|
| AcademyInfo λ¨λΈ | β… | `schema.prisma:203-207` | key-value |
| κ΄€λ¦¬μ μμ • κ°€λ¥ | β… | `PUT /academy/info` | Tier 1 |
| DBμ—μ„ λ™μ  λ΅λ“ | β… | `GET /academy/info` | Seed λ°μ΄ν„° |

### 5.4 μ»¤λ®¤λ‹ν‹° & μ±„ν…

| μ”κµ¬μ‚¬ν•­ | μƒνƒ | κµ¬ν„ | λΉ„κ³  |
|---------|------|------|------|
| κ²μ‹ν (λ””μ”¨ μ¤νƒ€μΌ) | β… | `community/*` API | μ™„λ£ |
| λ“κΈ€/μ¶”μ² μ‹μ¤ν… | β… | PostLike, CommentLike | μ™„λ£ |
| 1:1 DM (μ•”νΈν™”) | β… | `chat/rooms (type=dm)` | AES-256 |
| κ·Έλ£Ή μ±„ν… | β… | `chat/rooms (type=group)` | μ™„λ£ |

---

## β οΈ 6. λ°κ²¬λ λ¬Έμ μ  λ° κ°μ„ μ‚¬ν•­

### 6.1 MySQL μ „ν™ μ¤€λΉ„

**λ¬Έμ μ **:
- ν„μ¬ `schema.prisma`μ providerκ°€ `"sqlite"`λ΅ ν•λ“μ½”λ”©λ¨
- CMLMS μ”κµ¬μ‚¬ν•­: ν™κ²½λ³€μ κΈ°λ° Dual DB μ „λµ

**ν•΄κ²° λ°©μ•**:
```prisma
// ν„μ¬
datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

// μμ • ν•„μ” (ν™κ²½λ³€μ κΈ°λ°)
datasource db {
  provider = env("DATABASE_PROVIDER")  // "sqlite" λλ” "mysql"
  url      = env("DATABASE_URL")
}
```

**ν™κ²½λ³€μ μ¶”κ°€ ν•„μ”**:
```bash
# .env (κ°λ°)
DATABASE_PROVIDER=sqlite
DATABASE_URL=file:./prisma/dev.db

# .env.production (μ΄μ)
DATABASE_PROVIDER=mysql
DATABASE_URL=mysql://user:password@host:3306/database
```

### 6.2 Prisma Schema MySQL νΈν™μ„±

**ν„μ¬ μ΄μ**:
- SQLite μ „μ©μΌλ΅ μ„¤κ³„λμ–΄ μμ
- MySQL μ „ν™ μ‹ μΌλ¶€ νƒ€μ… μ΅°μ • ν•„μ”ν•  μ μμ

**κ¶μ¥ μμ •**:
- `@db.Text` μ–΄λ…Έν…μ΄μ… μ¶”κ°€ (κΈ΄ ν…μ¤νΈ ν•„λ“)
- UUID vs AUTO_INCREMENT μ „λµ κ³ λ ¤

### 6.3 κΈ°νƒ€ κ°μ„ μ‚¬ν•­

1. **Rate Limiting κ°’ μ΅°μ •**
   - ν„μ¬: κ°λ° ν™κ²½ κΈ°λ³Έκ°’
   - κ¶μ¥: ν”„λ΅λ•μ… ν™κ²½ κ³ λ ¤ν• κ°’

2. **μ—λ¬ λ©”μ‹μ§€ ν•κΈ€ν™”**
   - μΌλ¶€ μμ–΄ μ—λ¬ λ©”μ‹μ§€ μ΅΄μ¬
   - μ‚¬μ©μ μΉν™”μ  ν•κΈ€ λ©”μ‹μ§€λ΅ ν†µμΌ

3. **λ΅κΉ… μ‹μ¤ν…**
   - ν„μ¬: console.log
   - κ¶μ¥: Winston/Pino λ“± ν”„λ΅λ•μ… λ΅κΉ…

---

## β… 7. μΆ…ν•© ν‰κ°€

### κµ¬ν„ μ™„μ„±λ„

| ν•­λ© | μ™„μ„±λ„ | ν‰κ°€ |
|------|--------|------|
| λ³΄μ• (μ•”νΈν™”) | 100% | β… Random IV μ™„λ²½ κµ¬ν„ |
| λ³΄μ• (μΈμ¦/κ¶ν•) | 100% | β… JWT + Tier μ‹μ¤ν… |
| λ°μ΄ν„°λ² μ΄μ¤ | 95% | β οΈ MySQL μ „ν™ μ¤€λΉ„ ν•„μ” |
| API μ—”λ“ν¬μΈνΈ | 100% | β… 25κ° λ¨λ‘ κµ¬ν„ |
| Socket.io | 100% | β… μ‹¤μ‹κ°„ μ™„μ„± |
| ν•µμ‹¬ κΈ°λ¥ | 100% | β… λ¨λ“  μ”κµ¬μ‚¬ν•­ λ§μ΅± |
| λ¬Έμ„ν™” | 100% | β… μ™„λ²½ |

**μ „μ²΄ μ™„μ„±λ„**: **98%** β…

### λ―Έμ™„μ„± ν•­λ©

1. β οΈ **MySQL μ „ν™ μ¤€λΉ„** (2%)
   - ν™κ²½λ³€μ κΈ°λ° provider μ„¤μ • ν•„μ”
   - MySQL νΈν™μ„± ν…μ¤νΈ ν•„μ”

### CMLMS μ§€μ‹μ„ μ”κµ¬μ‚¬ν•­ μ¶©μ΅±λ„

| μΉ΄ν…κ³ λ¦¬ | μ¶©μ΅±λ„ |
|---------|--------|
| λ³΄μ• μ”κµ¬μ‚¬ν•­ | 100% β… |
| κΈ°λ¥ μ”κµ¬μ‚¬ν•­ | 100% β… |
| λ°μ΄ν„°λ² μ΄μ¤ | 95% β οΈ |
| μ•„ν‚¤ν…μ² | 100% β… |

---

## π― λ‹¤μ λ‹¨κ³„ κ¶μ¥μ‚¬ν•­

### μ°μ„ μμ„ 1 (ν•„μ)
1. β… MySQL μ „ν™ μ¤€λΉ„
   - schema.prisma ν™κ²½λ³€μ κΈ°λ° μμ •
   - .env.example μ—…λ°μ΄νΈ
   - MySQL λ§μ΄κ·Έλ μ΄μ… κ°€μ΄λ“ μ‘μ„±

### μ°μ„ μμ„ 2 (κ¶μ¥)
2. Rate Limiting κ°’ μ΅°μ •
3. ν”„λ΅λ•μ… λ΅κΉ… μ‹μ¤ν…
4. μ—λ¬ λ©”μ‹μ§€ ν•κΈ€ν™”

### μ°μ„ μμ„ 3 (μ„ νƒ)
5. μ„±λ¥ μµμ ν™”
6. μΊμ‹± μ „λµ
7. λ°±μ—… μλ™ν™”

---

**κ²€μ¦ μ™„λ£**: 2024-11-20  
**κ²°λ΅ **: CMLMS μ§€μ‹μ„μ ν•µμ‹¬ μ”κµ¬μ‚¬ν•­ κ±°μ λ¨λ‘ μ¶©μ΅± (98%)  
**λ‚¨μ€ μ‘μ—…**: MySQL μ „ν™ μ¤€λΉ„ (2%)
