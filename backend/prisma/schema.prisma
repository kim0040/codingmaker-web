generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

model User {
  id            String         @id @default(uuid())
  username      String         @unique
  password      String
  name          String
  phone         String?
  address       String?
  tag           String         @unique
  tier          Int
  role          String
  parentId      String?
  parent        User?          @relation("ParentChild", fields: [parentId], references: [id])
  children      User[]         @relation("ParentChild")
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  attendance    Attendance[]
  posts         Post[]
  comments      Comment[]
  messages      Message[]
  chatRooms     ChatRoom[]     @relation("ChatRoomMembers")
  enrolledCourses UserCourse[]
  sentFriendRequests     Friendship[] @relation("SentFriendRequests")
  receivedFriendRequests Friendship[] @relation("ReceivedFriendRequests")
  auditLogs AuditLog[]

  @@index([tag])
  @@index([tier])
  @@index([role])
  @@index([parentId])
}

model Attendance {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  date      DateTime @default(now())
  status    String
  note      String?
  createdAt DateTime @default(now())

  @@index([userId, date])
  @@index([date])
}

model Post {
  id        String    @id @default(uuid())
  title     String
  content   String
  category  String?
  authorId  String
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  views     Int       @default(0)
  isPinned  Boolean   @default(false)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  comments  Comment[]
  likes     PostLike[]

  @@index([authorId])
  @@index([category])
  @@index([createdAt])
  @@index([isPinned])
}

model Comment {
  id        String    @id @default(uuid())
  content   String
  postId    String
  post      Post      @relation(fields: [postId], references: [id], onDelete: Cascade)
  authorId  String
  author    User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
  likes     CommentLike[]

  @@index([postId])
  @@index([authorId])
  @@index([createdAt])
}

model PostLike {
  id        String   @id @default(uuid())
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())

  @@unique([postId, userId])
  @@index([postId])
}

model CommentLike {
  id        String   @id @default(uuid())
  commentId String
  comment   Comment  @relation(fields: [commentId], references: [id], onDelete: Cascade)
  userId    String
  createdAt DateTime @default(now())

  @@unique([commentId, userId])
  @@index([commentId])
}

model ChatRoom {
  id        String    @id @default(uuid())
  type      String
  name      String?
  members   User[]    @relation("ChatRoomMembers")
  messages  Message[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt

  @@index([type])
}

model Message {
  id          String    @id @default(uuid())
  content     String
  roomId      String
  room        ChatRoom  @relation(fields: [roomId], references: [id], onDelete: Cascade)
  authorId    String
  author      User      @relation(fields: [authorId], references: [id], onDelete: Cascade)
  isEncrypted Boolean   @default(false)
  isRead      Boolean   @default(false)
  createdAt   DateTime  @default(now())
  readAt      DateTime?

  @@index([roomId, createdAt])
  @@index([authorId])
  @@index([isRead])
}

model AuditLog {
  id        String   @id @default(uuid())
  actorId   String?
  actor     User?    @relation(fields: [actorId], references: [id])
  entity    String
  action    String
  oldValue  Json?
  newValue  Json?
  metadata  Json?
  createdAt DateTime @default(now())

  @@index([actorId])
  @@index([entity])
  @@index([action])
}

model Friendship {
  id        String   @id @default(uuid())
  userId    String
  user      User     @relation("SentFriendRequests", fields: [userId], references: [id], onDelete: Cascade)
  friendId  String
  friend    User     @relation("ReceivedFriendRequests", fields: [friendId], references: [id], onDelete: Cascade)
  status    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([userId, friendId])
  @@index([userId])
  @@index([friendId])
  @@index([status])
}

model Course {
  id          String       @id @default(uuid())
  title       String
  category    String
  description String?
  instructor  String?
  schedule    String?
  isActive    Boolean      @default(true)
  createdAt   DateTime     @default(now())
  updatedAt   DateTime     @updatedAt
  enrolledUsers UserCourse[]

  @@index([category])
  @@index([isActive])
}

model UserCourse {
  id         String   @id @default(uuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  courseId   String
  course     Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  progress   Int      @default(0)
  enrolledAt DateTime @default(now())

  @@unique([userId, courseId])
  @@index([userId])
  @@index([courseId])
}

model AcademyInfo {
  key       String   @id
  value     String
  updatedAt DateTime @updatedAt
}
